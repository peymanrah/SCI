============================= test session starts =============================
platform win32 -- Python 3.13.5, pytest-9.0.1, pluggy-1.6.0 -- D:\Structual Causal Invariant (SCI)\venv\Scripts\python.exe
cachedir: .pytest_cache
rootdir: D:\Structual Causal Invariant (SCI)
configfile: pyproject.toml
plugins: anyio-4.12.0, cov-7.0.0
collecting ... collected 86 items

tests/test_abstraction_layer.py::TestAbstractionLayer::test_initialization PASSED [  1%]
tests/test_abstraction_layer.py::TestAbstractionLayer::test_forward_shape PASSED [  2%]
tests/test_abstraction_layer.py::TestAbstractionLayer::test_structuralness_scores_range PASSED [  3%]
tests/test_abstraction_layer.py::TestAbstractionLayer::test_attention_mask_application PASSED [  4%]
tests/test_abstraction_layer.py::TestAbstractionLayer::test_gradient_flow PASSED [  5%]
tests/test_abstraction_layer.py::TestAbstractionLayer::test_statistics_computation PASSED [  6%]
tests/test_abstraction_layer.py::TestMultiHeadAbstractionLayer::test_initialization PASSED [  8%]
tests/test_abstraction_layer.py::TestMultiHeadAbstractionLayer::test_forward_shape PASSED [  9%]
tests/test_causal_binding_mechanism.py::TestCausalBindingArchitecture::test_binding_attention_shape PASSED [ 10%]
tests/test_causal_binding_mechanism.py::TestCausalBindingArchitecture::test_causal_intervention PASSED [ 11%]
tests/test_causal_binding_mechanism.py::TestCausalBindingArchitecture::test_broadcast_to_sequence PASSED [ 12%]
tests/test_causal_binding_mechanism.py::TestCausalBindingFunctionality::test_injection_modifies_hidden_states PASSED [ 13%]
tests/test_causal_binding_mechanism.py::TestCausalBindingFunctionality::test_no_injection_at_non_injection_layers PASSED [ 15%]
tests/test_causal_binding_mechanism.py::TestCausalBindingFunctionality::test_injection_at_all_specified_layers PASSED [ 16%]
tests/test_causal_binding_mechanism.py::TestCausalBindingFunctionality::test_gating_mechanism PASSED [ 17%]
tests/test_causal_binding_mechanism.py::TestCausalBindingFunctionality::test_gradient_flow PASSED [ 18%]
tests/test_causal_binding_mechanism.py::TestCausalBindingFunctionality::test_binding_is_deterministic_in_eval PASSED [ 19%]
tests/test_causal_binding_mechanism.py::TestCausalBindingFunctionality::test_handles_variable_batch_sizes PASSED [ 20%]
tests/test_causal_binding_mechanism.py::TestCausalBindingFunctionality::test_handles_variable_num_slots PASSED [ 22%]
tests/test_causal_binding_mechanism.py::TestCausalBindingFunctionality::test_end_to_end_pipeline PASSED [ 23%]
tests/test_causal_binding_mechanism.py::TestCausalBindingConfiguration::test_causal_intervention_can_be_disabled PASSED [ 24%]
tests/test_causal_binding_mechanism.py::TestCausalBindingConfiguration::test_injection_layers_configurable PASSED [ 25%]
tests/test_content_encoder.py::TestContentEncoderArchitecture::test_output_shape PASSED [ 26%]
tests/test_content_encoder.py::TestContentEncoderArchitecture::test_orthogonality_to_structure PASSED [ 27%]
tests/test_content_encoder.py::TestContentEncoderArchitecture::test_shared_embeddings PASSED [ 29%]
tests/test_content_encoder.py::TestContentEncoderFunctionality::test_data_leakage_prevention PASSED [ 30%]
tests/test_content_encoder.py::TestContentEncoderFunctionality::test_pooling_methods PASSED [ 31%]
tests/test_content_encoder.py::TestContentEncoderFunctionality::test_gradient_flow PASSED [ 32%]
tests/test_content_encoder.py::TestContentEncoderFunctionality::test_handles_variable_length_sequences PASSED [ 33%]
tests/test_content_encoder.py::TestContentEncoderFunctionality::test_deterministic_in_eval_mode PASSED [ 34%]
tests/test_content_encoder.py::TestContentEncoderFunctionality::test_attention_mask_application PASSED [ 36%]
tests/test_content_encoder.py::TestContentEncoderFunctionality::test_lightweight_architecture PASSED [ 37%]
tests/test_data_leakage.py::TestDataLeakagePrevention::test_instruction_mask_creation ERROR [ 38%]
tests/test_data_leakage.py::TestDataLeakagePrevention::test_structural_encoder_sees_only_instruction ERROR [ 39%]
tests/test_data_leakage.py::TestDataLeakagePrevention::test_no_response_in_structural_encoding ERROR [ 40%]
tests/test_data_leakage.py::TestDataLeakagePrevention::test_labels_correctly_mask_instruction PASSED [ 41%]
tests/test_hook_activation.py::TestHookActivation::test_hooks_activate_during_training_forward ERROR [ 43%]
tests/test_hook_activation.py::TestHookActivation::test_hooks_activate_during_inference ERROR [ 44%]
tests/test_hook_activation.py::TestHookActivation::test_hooks_modify_hidden_states ERROR [ 45%]
tests/test_hook_activation.py::TestHookActivation::test_hooks_work_with_generation ERROR [ 46%]
tests/test_hook_activation.py::TestHookActivation::test_structural_and_content_stored_during_forward ERROR [ 47%]
tests/test_hook_activation.py::TestHookActivation::test_hooks_handle_batch_size_variation ERROR [ 48%]
tests/test_hook_activation.py::TestHookActivation::test_hooks_handle_sequence_length_variation ERROR [ 50%]
tests/test_hook_activation.py::TestHookActivation::test_gradients_flow_through_hooks ERROR [ 51%]
tests/test_hook_registration.py::TestHookRegistration::test_hooks_registered_at_correct_layers ERROR [ 52%]
tests/test_hook_registration.py::TestHookRegistration::test_only_specified_layers_have_hooks ERROR [ 53%]
tests/test_hook_registration.py::TestHookRegistration::test_hooks_not_registered_when_cbm_disabled FAILED [ 54%]
tests/test_hook_registration.py::TestHookRegistration::test_hook_handles_stored ERROR [ 55%]
tests/test_hook_registration.py::TestHookRegistration::test_correct_number_of_injection_layers ERROR [ 56%]
tests/test_hook_registration.py::TestHookRegistration::test_injection_layers_within_bounds ERROR [ 58%]
tests/test_hook_registration.py::TestHookRegistration::test_injection_layers_ordered PASSED [ 59%]
tests/test_hook_registration.py::TestHookRegistration::test_causal_binding_mechanism_initialized ERROR [ 60%]
tests/test_hook_registration.py::TestHookConfiguration::test_injection_method_valid PASSED [ 61%]
tests/test_hook_registration.py::TestHookConfiguration::test_gate_init_range PASSED [ 62%]
tests/test_hook_registration.py::TestHookConfiguration::test_num_heads_matches_structural_encoder PASSED [ 63%]
tests/test_integration.py::TestComponentIntegration::test_structural_and_content_encoders_work_together PASSED [ 65%]
tests/test_integration.py::TestComponentIntegration::test_cbm_binds_structural_and_content PASSED [ 66%]
tests/test_integration.py::TestComponentIntegration::test_end_to_end_forward_pass_simulation FAILED [ 67%]
tests/test_integration.py::TestDataLeakageIntegration::test_instruction_mask_propagates_correctly FAILED [ 68%]
tests/test_integration.py::TestGradientFlow::test_gradients_flow_through_all_components FAILED [ 69%]
tests/test_losses.py::TestStructuralContrastiveLoss::test_loss_with_positive_pairs PASSED [ 70%]
tests/test_losses.py::TestStructuralContrastiveLoss::test_loss_with_no_positive_pairs PASSED [ 72%]
tests/test_losses.py::TestStructuralContrastiveLoss::test_similar_pairs_have_lower_loss PASSED [ 73%]
tests/test_losses.py::TestStructuralContrastiveLoss::test_works_with_slot_representations PASSED [ 74%]
tests/test_losses.py::TestCombinedLoss::test_all_loss_components PASSED  [ 75%]
tests/test_losses.py::TestCombinedLoss::test_scl_warmup_override PASSED  [ 76%]
tests/test_losses.py::TestCombinedLoss::test_no_scl_when_no_positive_pairs PASSED [ 77%]
tests/test_losses.py::TestCombinedLoss::test_orthogonality_loss_computation PASSED [ 79%]
tests/test_pair_generation.py::TestSCANStructureExtractor::test_simple_structure_extraction PASSED [ 80%]
tests/test_pair_generation.py::TestSCANStructureExtractor::test_multiple_actions PASSED [ 81%]
tests/test_pair_generation.py::TestSCANStructureExtractor::test_same_structure_detection PASSED [ 82%]
tests/test_pair_generation.py::TestSCANStructureExtractor::test_grouping_by_structure PASSED [ 83%]
tests/test_pair_generation.py::TestSCANPairGenerator::test_pair_matrix_generation PASSED [ 84%]
tests/test_pair_generation.py::TestSCANPairGenerator::test_batch_pair_labels PASSED [ 86%]
tests/test_pair_generation.py::TestSCANPairGenerator::test_pair_caching PASSED [ 87%]
tests/test_pair_generation.py::TestSCANPairGenerator::test_structure_statistics PASSED [ 88%]
tests/test_pair_generation.py::TestSCANPairGenerator::test_balanced_batch_sampling PASSED [ 89%]
tests/test_structural_encoder.py::TestStructuralEncoderArchitecture::test_output_shape PASSED [ 90%]
tests/test_structural_encoder.py::TestStructuralEncoderArchitecture::test_slot_queries_learnable FAILED [ 91%]
tests/test_structural_encoder.py::TestStructuralEncoderArchitecture::test_instruction_only_attention FAILED [ 93%]
tests/test_structural_encoder.py::TestStructuralEncoderArchitecture::test_abstraction_layers_inject_at_correct_positions FAILED [ 94%]
tests/test_structural_encoder.py::TestStructuralEncoderArchitecture::test_structural_scores_range PASSED [ 95%]
tests/test_structural_encoder.py::TestStructuralEncoderFunctionality::test_handles_variable_length_sequences PASSED [ 96%]
tests/test_structural_encoder.py::TestStructuralEncoderFunctionality::test_gradient_flow FAILED [ 97%]
tests/test_structural_encoder.py::TestStructuralEncoderFunctionality::test_deterministic_with_eval_mode FAILED [ 98%]
tests/test_structural_encoder.py::TestStructuralEncoderFunctionality::test_slot_attention_convergence PASSED [100%]

=================================== ERRORS ====================================
_ ERROR at setup of TestDataLeakagePrevention.test_instruction_mask_creation __
E   TypeError: TrainingConfig.__init__() got an unexpected keyword argument 'dataset'
_ ERROR at setup of TestDataLeakagePrevention.test_structural_encoder_sees_only_instruction _
E   TypeError: TrainingConfig.__init__() got an unexpected keyword argument 'dataset'
_ ERROR at setup of TestDataLeakagePrevention.test_no_response_in_structural_encoding _
E   TypeError: TrainingConfig.__init__() got an unexpected keyword argument 'dataset'
_ ERROR at setup of TestHookActivation.test_hooks_activate_during_training_forward _
E   AttributeError: 'types.SimpleNamespace' object has no attribute 'd_model'
---------------------------- Captured stdout setup ----------------------------
Loading base model: TinyLlama/TinyLlama-1.1B-Chat-v1.0
Model dimensions: d_model=2048, vocab_size=32000, num_layers=22
Initializing Structural Encoder...
---------------------------- Captured stderr setup ----------------------------
`torch_dtype` is deprecated! Use `dtype` instead!
__ ERROR at setup of TestHookActivation.test_hooks_activate_during_inference __
E   AttributeError: 'types.SimpleNamespace' object has no attribute 'd_model'
---------------------------- Captured stdout setup ----------------------------
Loading base model: TinyLlama/TinyLlama-1.1B-Chat-v1.0
Model dimensions: d_model=2048, vocab_size=32000, num_layers=22
Initializing Structural Encoder...
____ ERROR at setup of TestHookActivation.test_hooks_modify_hidden_states _____
E   AttributeError: 'types.SimpleNamespace' object has no attribute 'd_model'
---------------------------- Captured stdout setup ----------------------------
Loading base model: TinyLlama/TinyLlama-1.1B-Chat-v1.0
Model dimensions: d_model=2048, vocab_size=32000, num_layers=22
Initializing Structural Encoder...
____ ERROR at setup of TestHookActivation.test_hooks_work_with_generation _____
E   AttributeError: 'types.SimpleNamespace' object has no attribute 'd_model'
---------------------------- Captured stdout setup ----------------------------
Loading base model: TinyLlama/TinyLlama-1.1B-Chat-v1.0
Model dimensions: d_model=2048, vocab_size=32000, num_layers=22
Initializing Structural Encoder...
_ ERROR at setup of TestHookActivation.test_structural_and_content_stored_during_forward _
E   AttributeError: 'types.SimpleNamespace' object has no attribute 'd_model'
---------------------------- Captured stdout setup ----------------------------
Loading base model: TinyLlama/TinyLlama-1.1B-Chat-v1.0
Model dimensions: d_model=2048, vocab_size=32000, num_layers=22
Initializing Structural Encoder...
_ ERROR at setup of TestHookActivation.test_hooks_handle_batch_size_variation _
E   AttributeError: 'types.SimpleNamespace' object has no attribute 'd_model'
---------------------------- Captured stdout setup ----------------------------
Loading base model: TinyLlama/TinyLlama-1.1B-Chat-v1.0
Model dimensions: d_model=2048, vocab_size=32000, num_layers=22
Initializing Structural Encoder...
_ ERROR at setup of TestHookActivation.test_hooks_handle_sequence_length_variation _
E   AttributeError: 'types.SimpleNamespace' object has no attribute 'd_model'
---------------------------- Captured stdout setup ----------------------------
Loading base model: TinyLlama/TinyLlama-1.1B-Chat-v1.0
Model dimensions: d_model=2048, vocab_size=32000, num_layers=22
Initializing Structural Encoder...
___ ERROR at setup of TestHookActivation.test_gradients_flow_through_hooks ____
E   AttributeError: 'types.SimpleNamespace' object has no attribute 'd_model'
---------------------------- Captured stdout setup ----------------------------
Loading base model: TinyLlama/TinyLlama-1.1B-Chat-v1.0
Model dimensions: d_model=2048, vocab_size=32000, num_layers=22
Initializing Structural Encoder...
_ ERROR at setup of TestHookRegistration.test_hooks_registered_at_correct_layers _
E   AttributeError: 'types.SimpleNamespace' object has no attribute 'd_model'
---------------------------- Captured stdout setup ----------------------------
Loading base model: TinyLlama/TinyLlama-1.1B-Chat-v1.0
Model dimensions: d_model=2048, vocab_size=32000, num_layers=22
Initializing Structural Encoder...
_ ERROR at setup of TestHookRegistration.test_only_specified_layers_have_hooks _
E   AttributeError: 'types.SimpleNamespace' object has no attribute 'd_model'
---------------------------- Captured stdout setup ----------------------------
Loading base model: TinyLlama/TinyLlama-1.1B-Chat-v1.0
Model dimensions: d_model=2048, vocab_size=32000, num_layers=22
Initializing Structural Encoder...
_______ ERROR at setup of TestHookRegistration.test_hook_handles_stored _______
E   AttributeError: 'types.SimpleNamespace' object has no attribute 'd_model'
---------------------------- Captured stdout setup ----------------------------
Loading base model: TinyLlama/TinyLlama-1.1B-Chat-v1.0
Model dimensions: d_model=2048, vocab_size=32000, num_layers=22
Initializing Structural Encoder...
_ ERROR at setup of TestHookRegistration.test_correct_number_of_injection_layers _
E   AttributeError: 'types.SimpleNamespace' object has no attribute 'd_model'
---------------------------- Captured stdout setup ----------------------------
Loading base model: TinyLlama/TinyLlama-1.1B-Chat-v1.0
Model dimensions: d_model=2048, vocab_size=32000, num_layers=22
Initializing Structural Encoder...
_ ERROR at setup of TestHookRegistration.test_injection_layers_within_bounds __
E   AttributeError: 'types.SimpleNamespace' object has no attribute 'd_model'
---------------------------- Captured stdout setup ----------------------------
Loading base model: TinyLlama/TinyLlama-1.1B-Chat-v1.0
Model dimensions: d_model=2048, vocab_size=32000, num_layers=22
Initializing Structural Encoder...
_ ERROR at setup of TestHookRegistration.test_causal_binding_mechanism_initialized _
E   AttributeError: 'types.SimpleNamespace' object has no attribute 'd_model'
---------------------------- Captured stdout setup ----------------------------
Loading base model: TinyLlama/TinyLlama-1.1B-Chat-v1.0
Model dimensions: d_model=2048, vocab_size=32000, num_layers=22
Initializing Structural Encoder...
================================== FAILURES ===================================
E   AttributeError: 'types.SimpleNamespace' object has no attribute 'd_model'
---------------------------- Captured stdout call -----------------------------
Loading base model: TinyLlama/TinyLlama-1.1B-Chat-v1.0
Model dimensions: d_model=2048, vocab_size=32000, num_layers=22
Initializing Structural Encoder...
D:\Structual Causal Invariant (SCI)\sci\models\components\structural_encoder.py:52: AttributeError: 'types.SimpleNamespace' object has no attribute 'd_model'
E   RuntimeError: mat1 and mat2 shapes cannot be multiplied (16x512 and 2048x2048)
D:\Structual Causal Invariant (SCI)\venv\Lib\site-packages\torch\nn\modules\linear.py:125: RuntimeError: mat1 and mat2 shapes cannot be multiplied (16x512 and 2048x2048)
E   AssertionError: Structural encoder sees response tokens (diff=4.755116)
    assert 4.755115509033203 < 1e-05
D:\Structual Causal Invariant (SCI)\tests\test_integration.py:316: AssertionError: Structural encoder sees response tokens (diff=4.755116)
E   RuntimeError: mat1 and mat2 shapes cannot be multiplied (16x512 and 2048x2048)
D:\Structual Causal Invariant (SCI)\venv\Lib\site-packages\torch\nn\modules\linear.py:125: RuntimeError: mat1 and mat2 shapes cannot be multiplied (16x512 and 2048x2048)
E   AssertionError: Slot queries not found in slot attention module
    assert False
     +  where False = hasattr(SlotAttention(\n  num_slots=8, d_model=512, num_iterations=3\n  (norm_inputs): LayerNorm((512,), eps=1e-05, elementwise_affine=True)\n  (norm_slots): LayerNorm((512,), eps=1e-05, elementwise_affine=True)\n  (to_q): Linear(in_features=512, out_features=512, bias=False)\n  (to_k): Linear(in_features=512, out_features=512, bias=False)\n  (to_v): Linear(in_features=512, out_features=512, bias=False)\n  (gru): GRUCell(512, 512)\n  (mlp): Sequential(\n    (0): Linear(in_features=512, out_features=512, bias=True)\n    (1): ReLU()\n    (2): Linear(in_features=512, out_features=512, bias=True)\n  )\n  (norm_mlp): LayerNorm((512,), eps=1e-05, elementwise_affine=True)\n), 'slot_queries')
     +    where SlotAttention(\n  num_slots=8, d_model=512, num_iterations=3\n  (norm_inputs): LayerNorm((512,), eps=1e-05, elementwise_affine=True)\n  (norm_slots): LayerNorm((512,), eps=1e-05, elementwise_affine=True)\n  (to_q): Linear(in_features=512, out_features=512, bias=False)\n  (to_k): Linear(in_features=512, out_features=512, bias=False)\n  (to_v): Linear(in_features=512, out_features=512, bias=False)\n  (gru): GRUCell(512, 512)\n  (mlp): Sequential(\n    (0): Linear(in_features=512, out_features=512, bias=True)\n    (1): ReLU()\n    (2): Linear(in_features=512, out_features=512, bias=True)\n  )\n  (norm_mlp): LayerNorm((512,), eps=1e-05, elementwise_affine=True)\n) = StructuralEncoder(\n  (pos_encoding): RotaryPositionalEncoding(d_model=512, max_length=512, base=10000)\n  (input_projection): Linear(in_features=512, out_features=512, bias=True)\n  (layers): ModuleList(\n    (0-11): 12 x TransformerEncoderLayer(\n      (self_attn): MultiheadAttention(\n        (out_proj): NonDynamicallyQuantizableLinear(in_features=512, out_features=512, bias=True)\n      )\n      (linear1): Linear(in_features=512, out_features=2048, bias=True)\n      (dropout): Dropout(p=0.1, inplace=False)\n      (linear2): Linear(in_features=2048, out_features=512, bias=True)\n      (norm1): LayerNorm((512,), eps=1e-05, elementwise_affine=True)\n      (norm2): LayerNorm((512,), eps=1e-05, elementwise_affine=True)\n      (dropout1): Dropout(p=0.1, inplace=False)\n      (dropout2): Dropout(p=0.1, inplace=False)\n    )\n  )\n  (abstraction_layers): ModuleDict(\n    (3): AbstractionLayer(\n      d_model=512, hidden_dim=1024, residual_gate=0.1000\n      (structural_detector): Sequential(\n        (0): Linear(in_features=512, out_features=1024, bias=True)\n        (1): GELU(approximate='none')\n        (2): Dropout(p=0.1, inplace=False)\n        (3): Linear(in_features=1024, out_features=512, bias=True)\n        (4): Sigmoid()\n      )\n      (layer_norm): LayerNorm((512,), eps=1e-05, elementwise_affine=True)\n      (dropout): Dropout(p=0.1, inplace=False)\n    )\n    (6): AbstractionLayer(\n      d_model=512, hidden_dim=1024, residual_gate=0.1000\n      (structural_detector): Sequential(\n        (0): Linear(in_features=512, out_features=1024, bias=True)\n        (1): GELU(approximate='none')\n        (2): Dropout(p=0.1, inplace=False)\n        (3): Linear(in_features=1024, out_features=512, bias=True)\n        (4): Sigmoid()\n      )\n      (layer_norm): LayerNorm((512,), eps=1e-05, elementwise_affine=True)\n      (dropout): Dropout(p=0.1, inplace=False)\n    )\n    (9): AbstractionLayer(\n      d_model=512, hidden_dim=1024, residual_gate=0.1000\n      (structural_detector): Sequential(\n        (0): Linear(in_features=512, out_features=1024, bias=True)\n        (1): GELU(approximate='none')\n        (2): Dropout(p=0.1, inplace=False)\n        (3): Linear(in_features=1024, out_features=512, bias=True)\n        (4): Sigmoid()\n      )\n      (layer_norm): LayerNorm((512,), eps=1e-05, elementwise_affine=True)\n      (dropout): Dropout(p=0.1, inplace=False)\n    )\n  )\n  (slot_attention): SlotAttention(\n    num_slots=8, d_model=512, num_iterations=3\n    (norm_inputs): LayerNorm((512,), eps=1e-05, elementwise_affine=True)\n    (norm_slots): LayerNorm((512,), eps=1e-05, elementwise_affine=True)\n    (to_q): Linear(in_features=512, out_features=512, bias=False)\n    (to_k): Linear(in_features=512, out_features=512, bias=False)\n    (to_v): Linear(in_features=512, out_features=512, bias=False)\n    (gru): GRUCell(512, 512)\n    (mlp): Sequential(\n      (0): Linear(in_features=512, out_features=512, bias=True)\n      (1): ReLU()\n      (2): Linear(in_features=512, out_features=512, bias=True)\n    )\n    (norm_mlp): LayerNorm((512,), eps=1e-05, elementwise_affine=True)\n  )\n  (final_norm): LayerNorm((512,), eps=1e-05, elementwise_affine=True)\n  (embedding): Embedding(32000, 512)\n).slot_attention
D:\Structual Causal Invariant (SCI)\tests\test_structural_encoder.py:121: AssertionError: Slot queries not found in slot attention module
E   AssertionError: Structural representations differ by 4.185554 despite same instruction. This suggests structural encoder is attending to response tokens!
    assert 4.185553550720215 < 0.001
D:\Structual Causal Invariant (SCI)\tests\test_structural_encoder.py:184: AssertionError: Structural representations differ by 4.185554 despite same instruction. This suggests structural encoder is attending to response tokens!
E   AttributeError: 'StructuralEncoder' object has no attribute 'abstraction_layer_positions'
D:\Structual Causal Invariant (SCI)\venv\Lib\site-packages\torch\nn\modules\module.py:1940: AttributeError: 'StructuralEncoder' object has no attribute 'abstraction_layer_positions'
E   AttributeError: 'SlotAttention' object has no attribute 'slot_queries'
D:\Structual Causal Invariant (SCI)\venv\Lib\site-packages\torch\nn\modules\module.py:1940: AttributeError: 'SlotAttention' object has no attribute 'slot_queries'
E   AssertionError: Structural encoder is non-deterministic in eval mode
    assert False
     +  where False = <built-in method allclose of type object at 0x00007FFB2A6CE450>(tensor([[[ 1.1083, -1.1101, -0.4185,  ..., -1.1468, -0.2550,  0.8146],\n         [ 1.2225, -2.1596,  0.1361,  ..., -1.3439,  0.0131, -0.0648],\n         [ 1.3478, -0.4155,  0.4687,  ..., -0.4473, -0.1256,  0.0823],\n         ...,\n         [ 1.4824, -3.3686,  0.2042,  ..., -0.1473, -0.5049, -0.1279],\n         [ 1.2208, -1.4583,  0.3318,  ..., -0.0645, -0.1041,  0.8536],\n         [ 1.1363, -0.5605,  0.9175,  ..., -0.4953, -0.8697,  1.0700]],\n\n        [[ 1.1188, -0.7554,  0.6514,  ..., -0.0286, -0.6135,  0.4444],\n         [ 0.8025, -0.6054, -0.3566,  ..., -1.7281, -0.7340, -0.0248],\n         [ 1.2181, -0.9788,  0.3170,  ..., -0.3063, -1.0649,  0.0921],\n         ...,\n         [ 1.1259, -0.9739, -0.4525,  ..., -1.7976, -0.8285,  0.5215],\n         [ 1.5609, -0.7032,  0.1404,  ..., -1.5979, -0.5423,  0.8651],\n         [ 1.8054, -1.2249, -0.0380,  ..., -1.6909, -0.6351,  0.5128]]]), tensor([[[ 0.8880, -2.5902,  0.2628,  ..., -1.6441, -1.0070,  0.3086],\n         [ 0.8477, -0.3028, -0.1776,  ..., -0.2181,  0.1950,  0.4398],\n         [ 1.4538, -1.4892,  0.0257,  ..., -0.9669,  0.5486,  0.6325],\n         ...,\n         [ 1.5000,  0.2642, -0.5046,  ..., -0.5380, -0.2995,  0.4523],\n         [ 0.5881, -1.4938, -0.0523,  ..., -0.1779, -0.0067, -1.2690],\n         [ 1.1966, -1.3028, -0.0915,  ..., -1.0185, -0.4085,  0.7656]],\n\n        [[ 1.5531, -0.4831,  0.2508,  ..., -0.9436, -0.7656,  0.7284],\n         [ 1.7623, -1.0910, -1.0278,  ..., -0.7602, -0.7913, -0.2130],\n         [ 0.9885, -1.2877, -0.7632,  ..., -0.2887, -0.7816,  0.2009],\n         ...,\n         [ 1.3832, -0.8537, -0.2684,  ..., -0.5934, -0.3738,  0.3391],\n         [ 1.1020, -2.2922, -0.7238,  ..., -0.7580, -0.3830, -0.2677],\n         [ 1.0676, -1.5031,  1.0897,  ..., -1.6803, -1.0557,  0.3076]]]), atol=1e-06)
     +    where <built-in method allclose of type object at 0x00007FFB2A6CE450> = torch.allclose
D:\Structual Causal Invariant (SCI)\tests\test_structural_encoder.py:359: AssertionError: Structural encoder is non-deterministic in eval mode
=============================== tests coverage ================================
_______________ coverage: platform win32, python 3.13.5-final-0 _______________

Name                                              Stmts   Miss  Cover
---------------------------------------------------------------------
sci\__init__.py                                       4      0   100%
sci\config\__init__.py                                2      0   100%
sci\config\config_loader.py                         176     25    86%
sci\data\__init__.py                                  3      0   100%
sci\data\datasets\__init__.py                         2      0   100%
sci\data\datasets\scan_dataset.py                   125     64    49%
sci\data\pair_generators\__init__.py                  2      0   100%
sci\data\pair_generators\scan_pair_generator.py     170     62    64%
sci\data\scan_loader.py                              16     16     0%
sci\data\structure_extractors\__init__.py             2      0   100%
sci\data\structure_extractors\scan_extractor.py      98     59    40%
sci\evaluation\__init__.py                            3      3     0%
sci\evaluation\evaluator.py                         128    128     0%
sci\models\__init__.py                                3      0   100%
sci\models\components\__init__.py                     7      0   100%
sci\models\components\abstraction_layer.py           80     19    76%
sci\models\components\causal_binding.py             136     50    63%
sci\models\components\content_encoder.py            124     58    53%
sci\models\components\positional_encoding.py        109     67    39%
sci\models\components\slot_attention.py             104     46    56%
sci\models\components\structural_encoder.py         128     78    39%
sci\models\losses\__init__.py                         4      0   100%
sci\models\losses\combined_loss.py                  100     56    44%
sci\models\losses\eos_loss.py                        50     42    16%
sci\models\losses\scl_loss.py                       107     64    40%
sci\models\sci_model.py                             180    143    21%
sci\training\__init__.py                              2      2     0%
sci\training\trainer.py                             151    151     0%
---------------------------------------------------------------------
TOTAL                                              2016   1133    44%
Coverage HTML written to dir htmlcov
=========================== short test summary info ===========================
FAILED tests/test_hook_registration.py::TestHookRegistration::test_hooks_not_registered_when_cbm_disabled - AttributeError: 'types.SimpleNamespace' object has no attribute 'd_model'
FAILED tests/test_integration.py::TestComponentIntegration::test_end_to_end_forward_pass_simulation - RuntimeError: mat1 and mat2 shapes cannot be multiplied (16x512 and 2048x2048)
FAILED tests/test_integration.py::TestDataLeakageIntegration::test_instruction_mask_propagates_correctly - AssertionError: Structural encoder sees response tokens (diff=4.755116)
assert 4.755115509033203 < 1e-05
FAILED tests/test_integration.py::TestGradientFlow::test_gradients_flow_through_all_components - RuntimeError: mat1 and mat2 shapes cannot be multiplied (16x512 and 2048x2048)
FAILED tests/test_structural_encoder.py::TestStructuralEncoderArchitecture::test_slot_queries_learnable - AssertionError: Slot queries not found in slot attention module
assert False
 +  where False = hasattr(SlotAttention(\n  num_slots=8, d_model=512, num_iterations=3\n  (norm_inputs): LayerNorm((512,), eps=1e-05, elementwise_affine=True)\n  (norm_slots): LayerNorm((512,), eps=1e-05, elementwise_affine=True)\n  (to_q): Linear(in_features=512, out_features=512, bias=False)\n  (to_k): Linear(in_features=512, out_features=512, bias=False)\n  (to_v): Linear(in_features=512, out_features=512, bias=False)\n  (gru): GRUCell(512, 512)\n  (mlp): Sequential(\n    (0): Linear(in_features=512, out_features=512, bias=True)\n    (1): ReLU()\n    (2): Linear(in_features=512, out_features=512, bias=True)\n  )\n  (norm_mlp): LayerNorm((512,), eps=1e-05, elementwise_affine=True)\n), 'slot_queries')
 +    where SlotAttention(\n  num_slots=8, d_model=512, num_iterations=3\n  (norm_inputs): LayerNorm((512,), eps=1e-05, elementwise_affine=True)\n  (norm_slots): LayerNorm((512,), eps=1e-05, elementwise_affine=True)\n  (to_q): Linear(in_features=512, out_features=512, bias=False)\n  (to_k): Linear(in_features=512, out_features=512, bias=False)\n  (to_v): Linear(in_features=512, out_features=512, bias=False)\n  (gru): GRUCell(512, 512)\n  (mlp): Sequential(\n    (0): Linear(in_features=512, out_features=512, bias=True)\n    (1): ReLU()\n    (2): Linear(in_features=512, out_features=512, bias=True)\n  )\n  (norm_mlp): LayerNorm((512,), eps=1e-05, elementwise_affine=True)\n) = StructuralEncoder(\n  (pos_encoding): RotaryPositionalEncoding(d_model=512, max_length=512, base=10000)\n  (input_projection): Linear(in_features=512, out_features=512, bias=True)\n  (layers): ModuleList(\n    (0-11): 12 x TransformerEncoderLayer(\n      (self_attn): MultiheadAttention(\n        (out_proj): NonDynamicallyQuantizableLinear(in_features=512, out_features=512, bias=True)\n      )\n      (linear1): Linear(in_features=512, out_features=2048, bias=True)\n      (dropout): Dropout(p=0.1, inplace=False)\n      (linear2): Linear(in_features=2048, out_features=512, bias=True)\n      (norm1): LayerNorm((512,), eps=1e-05, elementwise_affine=True)\n      (norm2): LayerNorm((512,), eps=1e-05, elementwise_affine=True)\n      (dropout1): Dropout(p=0.1, inplace=False)\n      (dropout2): Dropout(p=0.1, inplace=False)\n    )\n  )\n  (abstraction_layers): ModuleDict(\n    (3): AbstractionLayer(\n      d_model=512, hidden_dim=1024, residual_gate=0.1000\n      (structural_detector): Sequential(\n        (0): Linear(in_features=512, out_features=1024, bias=True)\n        (1): GELU(approximate='none')\n        (2): Dropout(p=0.1, inplace=False)\n        (3): Linear(in_features=1024, out_features=512, bias=True)\n        (4): Sigmoid()\n      )\n      (layer_norm): LayerNorm((512,), eps=1e-05, elementwise_affine=True)\n      (dropout): Dropout(p=0.1, inplace=False)\n    )\n    (6): AbstractionLayer(\n      d_model=512, hidden_dim=1024, residual_gate=0.1000\n      (structural_detector): Sequential(\n        (0): Linear(in_features=512, out_features=1024, bias=True)\n        (1): GELU(approximate='none')\n        (2): Dropout(p=0.1, inplace=False)\n        (3): Linear(in_features=1024, out_features=512, bias=True)\n        (4): Sigmoid()\n      )\n      (layer_norm): LayerNorm((512,), eps=1e-05, elementwise_affine=True)\n      (dropout): Dropout(p=0.1, inplace=False)\n    )\n    (9): AbstractionLayer(\n      d_model=512, hidden_dim=1024, residual_gate=0.1000\n      (structural_detector): Sequential(\n        (0): Linear(in_features=512, out_features=1024, bias=True)\n        (1): GELU(approximate='none')\n        (2): Dropout(p=0.1, inplace=False)\n        (3): Linear(in_features=1024, out_features=512, bias=True)\n        (4): Sigmoid()\n      )\n      (layer_norm): LayerNorm((512,), eps=1e-05, elementwise_affine=True)\n      (dropout): Dropout(p=0.1, inplace=False)\n    )\n  )\n  (slot_attention): SlotAttention(\n    num_slots=8, d_model=512, num_iterations=3\n    (norm_inputs): LayerNorm((512,), eps=1e-05, elementwise_affine=True)\n    (norm_slots): LayerNorm((512,), eps=1e-05, elementwise_affine=True)\n    (to_q): Linear(in_features=512, out_features=512, bias=False)\n    (to_k): Linear(in_features=512, out_features=512, bias=False)\n    (to_v): Linear(in_features=512, out_features=512, bias=False)\n    (gru): GRUCell(512, 512)\n    (mlp): Sequential(\n      (0): Linear(in_features=512, out_features=512, bias=True)\n      (1): ReLU()\n      (2): Linear(in_features=512, out_features=512, bias=True)\n    )\n    (norm_mlp): LayerNorm((512,), eps=1e-05, elementwise_affine=True)\n  )\n  (final_norm): LayerNorm((512,), eps=1e-05, elementwise_affine=True)\n  (embedding): Embedding(32000, 512)\n).slot_attention
FAILED tests/test_structural_encoder.py::TestStructuralEncoderArchitecture::test_instruction_only_attention - AssertionError: Structural representations differ by 4.185554 despite same instruction. This suggests structural encoder is attending to response tokens!
assert 4.185553550720215 < 0.001
FAILED tests/test_structural_encoder.py::TestStructuralEncoderArchitecture::test_abstraction_layers_inject_at_correct_positions - AttributeError: 'StructuralEncoder' object has no attribute 'abstraction_layer_positions'
FAILED tests/test_structural_encoder.py::TestStructuralEncoderFunctionality::test_gradient_flow - AttributeError: 'SlotAttention' object has no attribute 'slot_queries'
FAILED tests/test_structural_encoder.py::TestStructuralEncoderFunctionality::test_deterministic_with_eval_mode - AssertionError: Structural encoder is non-deterministic in eval mode
assert False
 +  where False = <built-in method allclose of type object at 0x00007FFB2A6CE450>(tensor([[[ 1.1083, -1.1101, -0.4185,  ..., -1.1468, -0.2550,  0.8146],\n         [ 1.2225, -2.1596,  0.1361,  ..., -1.3439,  0.0131, -0.0648],\n         [ 1.3478, -0.4155,  0.4687,  ..., -0.4473, -0.1256,  0.0823],\n         ...,\n         [ 1.4824, -3.3686,  0.2042,  ..., -0.1473, -0.5049, -0.1279],\n         [ 1.2208, -1.4583,  0.3318,  ..., -0.0645, -0.1041,  0.8536],\n         [ 1.1363, -0.5605,  0.9175,  ..., -0.4953, -0.8697,  1.0700]],\n\n        [[ 1.1188, -0.7554,  0.6514,  ..., -0.0286, -0.6135,  0.4444],\n         [ 0.8025, -0.6054, -0.3566,  ..., -1.7281, -0.7340, -0.0248],\n         [ 1.2181, -0.9788,  0.3170,  ..., -0.3063, -1.0649,  0.0921],\n         ...,\n         [ 1.1259, -0.9739, -0.4525,  ..., -1.7976, -0.8285,  0.5215],\n         [ 1.5609, -0.7032,  0.1404,  ..., -1.5979, -0.5423,  0.8651],\n         [ 1.8054, -1.2249, -0.0380,  ..., -1.6909, -0.6351,  0.5128]]]), tensor([[[ 0.8880, -2.5902,  0.2628,  ..., -1.6441, -1.0070,  0.3086],\n         [ 0.8477, -0.3028, -0.1776,  ..., -0.2181,  0.1950,  0.4398],\n         [ 1.4538, -1.4892,  0.0257,  ..., -0.9669,  0.5486,  0.6325],\n         ...,\n         [ 1.5000,  0.2642, -0.5046,  ..., -0.5380, -0.2995,  0.4523],\n         [ 0.5881, -1.4938, -0.0523,  ..., -0.1779, -0.0067, -1.2690],\n         [ 1.1966, -1.3028, -0.0915,  ..., -1.0185, -0.4085,  0.7656]],\n\n        [[ 1.5531, -0.4831,  0.2508,  ..., -0.9436, -0.7656,  0.7284],\n         [ 1.7623, -1.0910, -1.0278,  ..., -0.7602, -0.7913, -0.2130],\n         [ 0.9885, -1.2877, -0.7632,  ..., -0.2887, -0.7816,  0.2009],\n         ...,\n         [ 1.3832, -0.8537, -0.2684,  ..., -0.5934, -0.3738,  0.3391],\n         [ 1.1020, -2.2922, -0.7238,  ..., -0.7580, -0.3830, -0.2677],\n         [ 1.0676, -1.5031,  1.0897,  ..., -1.6803, -1.0557,  0.3076]]]), atol=1e-06)
 +    where <built-in method allclose of type object at 0x00007FFB2A6CE450> = torch.allclose
ERROR tests/test_data_leakage.py::TestDataLeakagePrevention::test_instruction_mask_creation - TypeError: TrainingConfig.__init__() got an unexpected keyword argument 'dataset'
ERROR tests/test_data_leakage.py::TestDataLeakagePrevention::test_structural_encoder_sees_only_instruction - TypeError: TrainingConfig.__init__() got an unexpected keyword argument 'dataset'
ERROR tests/test_data_leakage.py::TestDataLeakagePrevention::test_no_response_in_structural_encoding - TypeError: TrainingConfig.__init__() got an unexpected keyword argument 'dataset'
ERROR tests/test_hook_activation.py::TestHookActivation::test_hooks_activate_during_training_forward - AttributeError: 'types.SimpleNamespace' object has no attribute 'd_model'
ERROR tests/test_hook_activation.py::TestHookActivation::test_hooks_activate_during_inference - AttributeError: 'types.SimpleNamespace' object has no attribute 'd_model'
ERROR tests/test_hook_activation.py::TestHookActivation::test_hooks_modify_hidden_states - AttributeError: 'types.SimpleNamespace' object has no attribute 'd_model'
ERROR tests/test_hook_activation.py::TestHookActivation::test_hooks_work_with_generation - AttributeError: 'types.SimpleNamespace' object has no attribute 'd_model'
ERROR tests/test_hook_activation.py::TestHookActivation::test_structural_and_content_stored_during_forward - AttributeError: 'types.SimpleNamespace' object has no attribute 'd_model'
ERROR tests/test_hook_activation.py::TestHookActivation::test_hooks_handle_batch_size_variation - AttributeError: 'types.SimpleNamespace' object has no attribute 'd_model'
ERROR tests/test_hook_activation.py::TestHookActivation::test_hooks_handle_sequence_length_variation - AttributeError: 'types.SimpleNamespace' object has no attribute 'd_model'
ERROR tests/test_hook_activation.py::TestHookActivation::test_gradients_flow_through_hooks - AttributeError: 'types.SimpleNamespace' object has no attribute 'd_model'
ERROR tests/test_hook_registration.py::TestHookRegistration::test_hooks_registered_at_correct_layers - AttributeError: 'types.SimpleNamespace' object has no attribute 'd_model'
ERROR tests/test_hook_registration.py::TestHookRegistration::test_only_specified_layers_have_hooks - AttributeError: 'types.SimpleNamespace' object has no attribute 'd_model'
ERROR tests/test_hook_registration.py::TestHookRegistration::test_hook_handles_stored - AttributeError: 'types.SimpleNamespace' object has no attribute 'd_model'
ERROR tests/test_hook_registration.py::TestHookRegistration::test_correct_number_of_injection_layers - AttributeError: 'types.SimpleNamespace' object has no attribute 'd_model'
ERROR tests/test_hook_registration.py::TestHookRegistration::test_injection_layers_within_bounds - AttributeError: 'types.SimpleNamespace' object has no attribute 'd_model'
ERROR tests/test_hook_registration.py::TestHookRegistration::test_causal_binding_mechanism_initialized - AttributeError: 'types.SimpleNamespace' object has no attribute 'd_model'
================== 9 failed, 60 passed, 17 errors in 57.98s ===================
